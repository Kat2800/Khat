<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Secure Chat</title>
<style>
  body { font-family: Arial; margin:0; padding:0; background:#f5f5f5; color:#333; }
  body.dark { background:#1e1e1e; color:#eee; }
  header { background:#4a90e2; color:white; padding:10px; display:flex; justify-content:space-between; align-items:center; }
  #meName { font-weight:bold; }
  #main { display:flex; height:calc(100vh-50px); }
  #contacts { border-right:1px solid #ccc; width:200px; padding:10px; background:#fafafa; }
  body.dark #contacts { background:#2a2a2a; }
  #contacts ul { list-style:none; padding:0; margin:0; }
  #contacts li { padding:5px; cursor:pointer; border-radius:5px; }
  #contacts li:hover { background:#ddd; }
  #chat { flex:1; display:flex; flex-direction:column; }
  #chatWith { padding:10px; font-weight:bold; border-bottom:1px solid #ccc; }
  #messages { flex:1; padding:10px; overflow-y:auto; }
  .msg { margin:5px 0; }
  .msg.me { text-align:right; }
  #inputBar { display:flex; padding:10px; }
  #inputBar input { flex:1; padding:5px; }
  #inputBar button { margin-left:5px; }
  #settingsPanel { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:white; padding:20px; border:1px solid #ccc; z-index:100; }
  body.dark #settingsPanel { background:#333; color:#fff; border-color:#666; }
</style>
</head>
<body>
<header>
  <div><span id="meName"></span> | <span id="connState">disconnesso</span></div>
  <div><button id="settingsBtn">‚öôÔ∏è Impostazioni</button></div>
</header>

<div id="main">
  <div id="contacts">
    <h3 id="contactsLabel">Contatti</h3>
    <ul id="contactList"></ul>
    <button id="addBtn">‚ûï Aggiungi</button><br><br>
    <button id="exportBtn">‚¨áÔ∏è Export contatti</button>
    <input type="file" id="importFile" style="display:none"/>
    <button id="importBtn">‚¨ÜÔ∏è Import contatti</button>
  </div>
  <div id="chat">
    <div id="chatWith">Seleziona un contatto</div>
    <div id="messages"></div>
    <div id="inputBar">
      <input id="msg" placeholder="Scrivi un messaggio..."/>
      <button id="sendBtn">Invia</button>
    </div>
  </div>
</div>

<div id="settingsPanel">
  <h3 id="settingsTitle">Impostazioni</h3>
  <label id="lblNickname">Nickname: <input id="newNickname"></label><br><br>
  <label><input type="checkbox" id="darkMode"> <span id="lblDarkMode">Modalit√† notte</span></label><br><br>
  <label id="lblLanguage">Lingua:
    <select id="language">
      <option value="it">Italiano</option>
      <option value="en">English</option>
    </select>
  </label><br><br>
  <button id="saveBtn">Salva impostazioni</button>
  <button onclick="document.getElementById('settingsPanel').style.display='none'">Chiudi</button>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const BROKER_URL = "wss://broker.emqx.io:8084/mqtt"; // broker WSS pubblico funzionante

// Stato locale
let me = { nickname:null };
let contacts = JSON.parse(localStorage.getItem("contacts")||"[]");
let settings = JSON.parse(localStorage.getItem("settings")||"{}");
let current = null;

// Traduzioni
const translations = {
  it:{me:"Tu",contacts:"Contatti",settings:"Impostazioni",dark:"Modalit√† notte",
      nickname:"Nickname",language:"Lingua",save:"Salva impostazioni",addContact:"Aggiungi contatto",
      export:"Esporta",import:"Importa"},
  en:{me:"You",contacts:"Contacts",settings:"Settings",dark:"Dark mode",
      nickname:"Nickname",language:"Language",save:"Save settings",addContact:"Add contact",
      export:"Export",import:"Import"}
};

// Helpers
const $=s=>document.querySelector(s);
function log(html,cls=""){ const d=$("#messages"); const e=document.createElement("div"); e.className="msg "+cls; e.innerHTML=html; d.appendChild(e); d.scrollTop=d.scrollHeight; }
function redrawContacts(){ const ul=$("#contactList"); ul.innerHTML=""; contacts.forEach((c,i)=>{ const li=document.createElement("li"); li.textContent=c.nickname; li.onclick=()=>switchChat(i); ul.appendChild(li); }); persistContacts(); }
function persistSettings(){ localStorage.setItem("settings",JSON.stringify(settings)); }
function persistContacts(){ localStorage.setItem("contacts",JSON.stringify(contacts)); }

// Applica lingua
function applyLanguage(){
  const dict=translations[settings.language||"it"];
  $("#contactsLabel").textContent=dict.contacts;
  $("#settingsTitle").textContent=dict.settings;
  $("#lblNickname").textContent=dict.nickname;
  $("#lblDarkMode").textContent=dict.dark;
  $("#lblLanguage").textContent=dict.language;
  $("#saveBtn").textContent=dict.save;
  $("#addBtn").textContent=dict.addContact;
  $("#exportBtn").textContent=dict.export;
  $("#importBtn").textContent=dict.import;
}

// Settings
function openSettings(){
  $("#newNickname").value=settings.nickname||me.nickname;
  $("#darkMode").checked=settings.darkMode||false;
  $("#language").value=settings.language||"it";
  $("#settingsPanel").style.display="block";
}
function saveSettings(){
  settings.nickname=$("#newNickname").value.trim()||me.nickname;
  settings.darkMode=$("#darkMode").checked;
  settings.language=$("#language").value;
  me.nickname=settings.nickname;
  $("#meName").textContent=me.nickname;
  if(settings.darkMode)document.body.classList.add("dark"); else document.body.classList.remove("dark");
  applyLanguage();
  persistSettings();
  $("#settingsPanel").style.display="none";
}

// Chat
function switchChat(i){
  current=contacts[i];
  $("#chatWith").textContent="Chat con "+current.nickname;
  $("#messages").innerHTML="";
}

// MQTT
let client = mqtt.connect(BROKER_URL, {clientId:"chat_"+Math.floor(Math.random()*1000)});
client.on("connect",()=>$("#connState").textContent="connesso");
client.on("reconnect",()=>$("#connState").textContent="riconnessione...");
client.on("close",()=>$("#connState").textContent="disconnesso");
client.on("message", (topic, message) => {
  try {
    const data = JSON.parse(message.toString());
    if (data.from === me.nickname) return; // ignora i tuoi
    log(`<b>${data.from}:</b> ${data.text}`);
  } catch (e) {
    console.error("Messaggio non valido", e);
  }
});


// Funzioni
$("#sendBtn").onclick = () => {
  if (!current) return;
  const txt = $("#msg").value.trim();
  if (!txt) return;
  $("#msg").value = "";

  // Mostra subito il messaggio nella tua chat
  log(`<div class="me"><b>${translations[settings.language].me}:</b> ${txt}</div>`, "me");

  // üî• Invia come JSON
  const payload = JSON.stringify({ from: me.nickname, text: txt });
  client.publish("chat/" + current.nickname, payload);
};

$("#msg").addEventListener("keydown",e=>{ if(e.key==="Enter")$("#sendBtn").click(); });
$("#addBtn").onclick=()=>{ const nick=prompt("Nickname contatto?"); if(!nick)return; contacts.push({nickname:nick}); redrawContacts(); client.subscribe("chat/"+nick); };
$("#exportBtn").onclick=()=>{ const blob=new Blob([JSON.stringify(contacts,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="contacts.json"; a.click(); URL.revokeObjectURL(url); };
$("#importBtn").onclick=()=>$("#importFile").click();
$("#importFile").onchange=e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{ try{ contacts=JSON.parse(ev.target.result); persistContacts(); redrawContacts(); alert("Contatti importati!"); } catch{ alert("File non valido"); } }; r.readAsText(f); };

// Init
window.onload=()=>{
  me.nickname=settings.nickname||("user"+Math.floor(Math.random()*999));
  $("#meName").textContent=me.nickname;
  if(settings.darkMode) document.body.classList.add("dark");
  applyLanguage();
  redrawContacts();
  client.subscribe(contacts.map(c=>"chat/"+c.nickname));
  $("#settingsBtn").addEventListener("click",openSettings);
  $("#saveBtn").addEventListener("click",saveSettings);
};
</script>
</body>
</html>


