<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const BROKER_URL = "wss://broker.emqx.io:8084/mqtt";

// Stato locale
let me={nickname:null};
let contacts=JSON.parse(localStorage.getItem("contacts")||"[]");
let settings=JSON.parse(localStorage.getItem("settings")||"{}");
let current=null;

// Traduzioni base
const translations={it:{me:"Tu"},en:{me:"You"}};

// Helpers
const $=s=>document.querySelector(s);
function log(html,cls=""){ const d=$("#messages"); const e=document.createElement("div"); e.className="msg "+cls; e.innerHTML=html; d.appendChild(e); d.scrollTop=d.scrollHeight; }
function persistContacts(){ localStorage.setItem("contacts",JSON.stringify(contacts)); }
function persistSettings(){ localStorage.setItem("settings",JSON.stringify(settings)); }

// MQTT
let client=mqtt.connect(BROKER_URL,{clientId:"chat_"+Math.floor(Math.random()*1000)});
client.on("connect",()=>$("#connState").textContent="connesso");
client.on("close",()=>$("#connState").textContent="disconnesso");
client.on("reconnect",()=>$("#connState").textContent="riconnessione...");

// Topic unico per coppia di utenti
function dmTopic(u1,u2){ return ["chat",u1,u2].sort().join("_"); }

// Quando arriva un messaggio
client.on("message",(topic,message)=>{
  if(!current) return;
  const txt=message.toString();
  // Mostra solo messaggi del topic attuale
  if(topic===dmTopic(me.nickname,current.nickname)){
    log("<b>"+current.nickname+":</b> "+txt);
  }
});

// Chat
function switchChat(i){
  current=contacts[i];
  $("#chatWith").textContent="Chat con "+current.nickname;
  $("#messages").innerHTML="";
  const topic=dmTopic(me.nickname,current.nickname);
  client.subscribe(topic);
}

$("#sendBtn").onclick=()=>{
  if(!current) return;
  const txt=$("#msg").value.trim();
  if(!txt) return;
  $("#msg").value="";
  const topic=dmTopic(me.nickname,current.nickname);
  log("<div class='me'><b>"+translations[settings.language||"it"].me+':</b> '+txt+"</div>","me");
  client.publish(topic,txt);
};

// Aggiungi contatto
$("#addBtn").onclick=()=>{
  const nick=prompt("Nickname contatto?");
  if(!nick) return;
  contacts.push({nickname:nick});
  persistContacts();
  redrawContacts();
};

// Redraw contatti
function redrawContacts(){
  const ul=$("#contactList");
  ul.innerHTML="";
  contacts.forEach((c,i)=>{
    const li=document.createElement("li");
    li.textContent=c.nickname;
    li.onclick=()=>switchChat(i);
    ul.appendChild(li);
  });
}

// Init
window.onload=()=>{
  me.nickname=settings.nickname||("user"+Math.floor(Math.random()*999));
  $("#meName").textContent=me.nickname;
  redrawContacts();
};
</script>
