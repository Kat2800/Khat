<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Secure Chat</title>
<style>
  body { font-family: Arial; margin:0; padding:0; background:#f5f5f5; color:#333; }
  body.dark { background:#1e1e1e; color:#eee; }
  header { background:#4a90e2; color:white; padding:10px; display:flex; justify-content:space-between; align-items:center; }
  #meName { font-weight:bold; }
  #main { display:flex; height:calc(100vh-50px); }
  #contacts { border-right:1px solid #ccc; width:200px; padding:10px; background:#fafafa; }
  body.dark #contacts { background:#2a2a2a; }
  #contacts ul { list-style:none; padding:0; margin:0; }
  #contacts li { padding:5px; cursor:pointer; border-radius:5px; }
  #contacts li:hover { background:#ddd; }
  #chat { flex:1; display:flex; flex-direction:column; }
  #chatWith { padding:10px; font-weight:bold; border-bottom:1px solid #ccc; }
  #messages { flex:1; padding:10px; overflow-y:auto; }
  .msg { margin:5px 0; }
  .msg.me { text-align:right; }
  #inputBar { display:flex; padding:10px; }
  #inputBar input { flex:1; padding:5px; }
  #inputBar button { margin-left:5px; }
  #settingsPanel { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:white; padding:20px; border:1px solid #ccc; z-index:100; }
  body.dark #settingsPanel { background:#333; color:#fff; border-color:#666; }
</style>
</head>
<body>
<header>
  <div><span id="meName"></span> | <span id="connState">disconnesso</span></div>
  <div><button id="settingsBtn">⚙️ Impostazioni</button></div>
</header>

<div id="main">
  <div id="contacts">
    <h3 id="contactsLabel">Contatti</h3>
    <ul id="contactList"></ul>
    <button id="addBtn">➕ Aggiungi</button><br><br>
    <button id="exportBtn">⬇️ Export contatti</button>
    <input type="file" id="importFile" style="display:none"/>
    <button id="importBtn">⬆️ Import contatti</button>
  </div>
  <div id="chat">
    <div id="chatWith">Seleziona un contatto</div>
    <div id="messages"></div>
    <div id="inputBar">
      <input id="msg" placeholder="Scrivi un messaggio..."/>
      <button id="sendBtn">Invia</button>
    </div>
  </div>
</div>

<div id="settingsPanel">
  <h3 id="settingsTitle">Impostazioni</h3>
  <label id="lblNickname">Nickname: <input id="newNickname"></label><br><br>
  <label><input type="checkbox" id="darkMode"> <span id="lblDarkMode">Modalità notte</span></label><br><br>
  <label id="lblLanguage">Lingua:
    <select id="language">
      <option value="it">Italiano</option>
      <option value="en">English</option>
    </select>
  </label><br><br>
  <button id="saveBtn">Salva impostazioni</button>
  <button onclick="document.getElementById('settingsPanel').style.display='none'">Chiudi</button>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const BROKER_URL = "wss://broker.emqx.io:8084/mqtt";

// Stato locale
let me={nickname:null};
let contacts=JSON.parse(localStorage.getItem("contacts")||"[]");
let settings=JSON.parse(localStorage.getItem("settings")||"{}");
let current=null;

// Traduzioni base
const translations={it:{me:"Tu"},en:{me:"You"}};

// Helpers
const $=s=>document.querySelector(s);
function log(html,cls=""){ const d=$("#messages"); const e=document.createElement("div"); e.className="msg "+cls; e.innerHTML=html; d.appendChild(e); d.scrollTop=d.scrollHeight; }
function persistContacts(){ localStorage.setItem("contacts",JSON.stringify(contacts)); }
function persistSettings(){ localStorage.setItem("settings",JSON.stringify(settings)); }

// MQTT
let client=mqtt.connect(BROKER_URL,{clientId:"chat_"+Math.floor(Math.random()*1000)});
client.on("connect",()=>$("#connState").textContent="connesso");
client.on("close",()=>$("#connState").textContent="disconnesso");
client.on("reconnect",()=>$("#connState").textContent="riconnessione...");

// Topic unico per coppia di utenti
function dmTopic(u1,u2){ return ["chat",u1,u2].sort().join("_"); }

// Quando arriva un messaggio
client.on("message",(topic,message)=>{
  if(!current) return;
  const txt=message.toString();
  // Mostra solo messaggi del topic attuale
  if(topic===dmTopic(me.nickname,current.nickname)){
    log("<b>"+current.nickname+":</b> "+txt);
  }
});

// Chat
function switchChat(i){
  current=contacts[i];
  $("#chatWith").textContent="Chat con "+current.nickname;
  $("#messages").innerHTML="";
  const topic=dmTopic(me.nickname,current.nickname);
  client.subscribe(topic);
}

$("#sendBtn").onclick=()=>{
  if(!current) return;
  const txt=$("#msg").value.trim();
  if(!txt) return;
  $("#msg").value="";
  const topic=dmTopic(me.nickname,current.nickname);
  log("<div class='me'><b>"+translations[settings.language||"it"].me+':</b> '+txt+"</div>","me");
  client.publish(topic,txt);
};

// Aggiungi contatto
$("#addBtn").onclick=()=>{
  const nick=prompt("Nickname contatto?");
  if(!nick) return;
  contacts.push({nickname:nick});
  persistContacts();
  redrawContacts();
};

// Redraw contatti
function redrawContacts(){
  const ul=$("#contactList");
  ul.innerHTML="";
  contacts.forEach((c,i)=>{
    const li=document.createElement("li");
    li.textContent=c.nickname;
    li.onclick=()=>switchChat(i);
    ul.appendChild(li);
  });
}

// Init
window.onload=()=>{
  me.nickname=settings.nickname||("user"+Math.floor(Math.random()*999));
  $("#meName").textContent=me.nickname;
  redrawContacts();
};
</script>

</body>
</html>
